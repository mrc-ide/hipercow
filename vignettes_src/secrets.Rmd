---
title: "Using secrets on the cluster"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{dide-cluster}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
source("../vignettes/common.R")
vignette_root <- new_hipercow_root_path(TRUE)
set_vignette_root(vignette_root)
```

```{r, echo = FALSE, results = "asis"}
add_header()
```

# Using cyphr

We assume that you have followed the ["data encryption" vignette](https://docs.ropensci.org/cyphr/articles/data.html) in cyphr and that you are running from the same directory that it is set up for.  You may or may not be using orderly with this.  We'll quickly set up the same basic structure:

We configure hipercow at this directory:

```{r}
library(hipercow)
hipercow_init()
hipercow_configure(driver = "dide-windows")
```

We have ssh keys that work for **our machine**.  These will have a password, but for the purposes of this vignette you will not see the password prompt

```{r include = FALSE}
path_key_local <- cyphr::ssh_keygen(password = FALSE)
Sys.setenv(USER_KEY = file.path(path_key_local, "id_rsa"),
           USER_PUBKEY = file.path(path_key_local, "id_rsa.pub"))
```

```{r}
cyphr::data_admin_init(".")
```

We can locally work with this key just fine to encrypt some small secret data set, `x`

```{r}
x <- runif(10)
```

```{r}
key <- cyphr::data_key()
cyphr::encrypt(saveRDS(x, "data.rds"), key)
```

What we want to do is to write a cluster job that can use this secret data.

Firstly, we need to install cyphr.

```{r}
hipercow_provision(method = "pkgdepends", refs = "cyphr")
```

```{r}
t <- task_create_expr(
  cyphr::decrypt(readRDS("data.rds"), cyphr::data_key()))
```

```{r include = FALSE}
task_wait(t)
```

This will fail:

```{r}
task_result(t)
```

The reason why it fails is because the cluster cannot see the key that we are using to work with cyphr; the `~/.ssh/id_rsa.pub` referred to here would be on the cluster node that ran the job and not the key that exists on your machine.

What we can do is to create another key that will be found in your network home directory:

```{r}
dide_generate_keypair()
```

We need to authorise this key with cyphr, which we can do by running a short cluster job:

```{r}
t <- task_create_expr(cyphr::data_request_access())
```

```{r include = FALSE}
task_wait(t)
```

Once that has run, we will see the request for access, which is actually us but from the cluster:

```{r}
cyphr::data_admin_list_requests()
```

We can authorise ourselves:

```{r}
cyphr::data_admin_authorise(yes = TRUE)
```

And now we can run our jobs that require encrypted data

```{r}
t <- task_create_expr(
  cyphr::decrypt(readRDS("data.rds"), cyphr::data_key()))
```

```{r include = FALSE}
task_wait(t)
```

This time we can read the data!

```{r}
task_result(t)
```
