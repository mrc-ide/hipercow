<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Environments • hipercow</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Environments">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hipercow</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/hipercow.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>General</h6></li>
    <li><a class="dropdown-item" href="../articles/packages.html">Packages and provisioning</a></li>
    <li><a class="dropdown-item" href="../articles/parallel.html">Parallel Tasks</a></li>
    <li><a class="dropdown-item" href="../articles/troubleshooting.html">Troubleshooting</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Details</h6></li>
    <li><a class="dropdown-item" href="../articles/details.html">Details</a></li>
    <li><a class="dropdown-item" href="../articles/environments.html">Environments</a></li>
    <li><a class="dropdown-item" href="../articles/stan.html">Using stan</a></li>
    <li><a class="dropdown-item" href="../articles/INLA.html">Using INLA on Windows</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Clusters</h6></li>
    <li><a class="dropdown-item" href="../articles/dide-cluster.html">The DIDE Cluster</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced topics</h6></li>
    <li><a class="dropdown-item" href="../articles/workers.html">Workers</a></li>
    <li><a class="dropdown-item" href="../articles/administration.html">Administration</a></li>
    <li><a class="dropdown-item" href="../articles/migration.html">Migration from didehpc</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/hipercow/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Environments</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/hipercow/blob/main/vignettes/environments.Rmd" class="external-link"><code>vignettes/environments.Rmd</code></a></small>
      <div class="d-none name"><code>environments.Rmd</code></div>
    </div>

    
    
<p>It is likely that the code that you want to run uses other code
written by someone else, or code that you have written yourself. This
vignette covers how you can make this code available to your tasks,
covering:</p>
<ul>
<li>Loading packages automatically</li>
<li>Using environments to avoid sending large files over the
network</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/hipercow" class="external-link">hipercow</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/hipercow_init.html">hipercow_init</a></span><span class="op">(</span>driver <span class="op">=</span> <span class="st">"example"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Initialised hipercow at '.' (/home/runner/work/_temp/hv-20250513-2f9b482552ec)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Configured hipercow to use 'example'</span></span></code></pre></div>
<div class="section level2">
<h2 id="basics">Basics<a class="anchor" aria-label="anchor" href="#basics"></a>
</h2>
<p>There are two main things that make up an “environment”:</p>
<ul>
<li>a set of packages that you would like attached (loaded via
<code><a href="https://rdrr.io/r/base/library.html" class="external-link">library()</a></code>)</li>
<li>a set of source files that you would like loaded into the session
(via <code><a href="https://rdrr.io/r/base/source.html" class="external-link">source()</a></code>)</li>
</ul>
<p>Because you can do anything you want within a source file (including
loading packages!) this is very flexible.</p>
<p>Here’s what is going on with the default environment:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/task_create_expr.html">task_create_expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>session <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span>, objects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Submitted task '6522711e8e0f59b31975df1178c2e800' using 'example'</span></span>
<span><span class="fu"><a href="../reference/task_wait.html">task_wait</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="../reference/task_result.html">task_result</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; $session</span></span>
<span><span class="co">#&gt; R version 4.5.0 (2025-04-11)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 24.04.2 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt; [1] compiler_4.5.0 cli_3.6.5      withr_3.0.2    hipercow_1.1.5 rlang_1.1.6   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objects</span></span>
<span><span class="co">#&gt; character(0)</span></span></code></pre></div>
<p>You can see that there are few <strong>attached</strong> packages
(these are packages that are loaded via <code>library</code> and whose
functions are available) but there are a couple of extra
<strong>loaded</strong> packages, for example<code>hipercow</code> and
its dependencies such as <code>cli</code> (these are packages that R has
loaded but functions of which are not available without
<code>::</code>).</p>
<p>The <code>objects</code> field shows the objects loaded into the
session; this is empty because the session has nothing in it.</p>
<div class="section level3">
<h3 id="loading-packages">Loading packages<a class="anchor" aria-label="anchor" href="#loading-packages"></a>
</h3>
<p>Your code might want to use functions from a package. For example, we
might want to use the <code>say</code> function from the
<code>cowsay</code> package</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/task_create_expr.html">task_create_expr</a></span><span class="op">(</span><span class="fu">say</span><span class="op">(</span><span class="st">"Moooo"</span>, by <span class="op">=</span> <span class="st">"cow"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Submitted task '84e68280c55ebb806a853de38ac515ee' using 'example'</span></span>
<span><span class="fu"><a href="../reference/task_wait.html">task_wait</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="fu"><a href="../reference/task_result.html">task_result</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;simpleError in say("Moooo", by = "cow"): could not find function "say"&gt;</span></span></code></pre></div>
<p>This task fails and the error message here indicates the problem: the
<code>say()</code> function is not found. We could run this as
<code>cowsay::say</code> but this might be inconvenient or just not what
we prefer to do. We need to arrange for <code><a href="https://github.com/sckott/cowsay" class="external-link">library(cowsay)</a></code> to
be run before trying to run our expression.</p>
<p>To do this, we update the <strong>default environment</strong>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/hipercow_environment.html">hipercow_environment_create</a></span><span class="op">(</span>packages <span class="op">=</span> <span class="st">"cowsay"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Created environment 'default'</span></span></code></pre></div>
<p>This time our task succeeds:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/task_create_expr.html">task_create_expr</a></span><span class="op">(</span><span class="fu">say</span><span class="op">(</span><span class="st">"Moooooo"</span>, by <span class="op">=</span> <span class="st">"cow"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Submitted task '3ce306e52326523f371c02040ac86498' using 'example'</span></span>
<span><span class="fu"><a href="../reference/task_wait.html">task_wait</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>Looking at the logs, we can see the glorious output of our task:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/task_log.html">task_log_show</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">hipercow 1.1.5 running at '/home/runner/work/_temp/hv-20250513-2f9b482552ec'</span> </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> library paths:</span></span>
<span><span class="co">#&gt; • /home/runner/work/_temp/Library</span></span>
<span><span class="co">#&gt; • /opt/R/4.5.0/lib/R/site-library</span></span>
<span><span class="co">#&gt; • /opt/R/4.5.0/lib/R/library</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> id: 3ce306e52326523f371c02040ac86498</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> starting at: 2025-05-13 06:44:28.836511</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Task type: expression</span></span>
<span><span class="co">#&gt; • Expression: say("Moooooo", by = "cow")</span></span>
<span><span class="co">#&gt; • Locals: (none)</span></span>
<span><span class="co">#&gt; • Environment: default</span></span>
<span><span class="co">#&gt;   R_GC_MEM_GROW: 3</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Loading environment 'default'...</span></span>
<span><span class="co">#&gt; • packages: <span style="font-weight: bold;">cowsay</span></span></span>
<span><span class="co">#&gt; • sources: <span style="font-style: italic;">(none)</span></span></span>
<span><span class="co">#&gt; • globals: <span style="font-style: italic;">(none)</span></span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> status: failure</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Error: there is no package called ‘cowsay’</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> finishing at: 2025-05-13 06:44:28.836511 (elapsed: 0.307 secs)</span></span></code></pre></div>
<p>We can also see the logs say:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>ℹ Loading environment <span class="st">'default'</span>...</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>• packages<span class="sc">:</span> cowsay</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>• sources<span class="sc">:</span> (none)</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>• globals<span class="sc">:</span> (none)</span></code></pre></div>
<p>As the task starts up, and before it runs our code, it has loaded
<code>default</code> and that has attached <code>cowsay</code>.</p>
<p>You can see what is in the default environment by using
<code><a href="../reference/hipercow_environment.html">hipercow_environment_show()</a></code></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/hipercow_environment.html">hipercow_environment_show</a></span><span class="op">(</span><span class="st">"default"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">hipercow environment 'default'</span> <span style="color: #00BBBB;">──────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; • packages: <span style="font-weight: bold;">cowsay</span></span></span>
<span><span class="co">#&gt; • sources: <span style="font-style: italic;">(none)</span></span></span>
<span><span class="co">#&gt; • globals: <span style="font-style: italic;">(none)</span></span></span></code></pre></div>
<p>which prints the same information.</p>
<p>You can list as many packages as you want, and they will be loaded in
order.</p>
</div>
<div class="section level3">
<h3 id="loading-your-own-functions">Loading your own functions<a class="anchor" aria-label="anchor" href="#loading-your-own-functions"></a>
</h3>
<p>Now, suppose we want to change the length of the moo that the cow
produces. We might write a function.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">moo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"M%s!"</span>, <span class="fu"><a href="https://rdrr.io/r/base/strrep.html" class="external-link">strrep</a></span><span class="op">(</span><span class="st">"o"</span>, <span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Ignoring the cluster for a minute, if you wanted to use this code you
would ordinarily use <code>source</code> to load it:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"moo.R"</span><span class="op">)</span></span>
<span><span class="fu">moo</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Mooooo!"</span></span></code></pre></div>
<p>We need to do the same thing on the cluster, as by default it would
not be found:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/task_create_expr.html">task_create_expr</a></span><span class="op">(</span><span class="fu">say</span><span class="op">(</span><span class="fu">moo</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"cow"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Submitted task 'a97aa1e118d79622616cae6c6e57f120' using 'example'</span></span>
<span><span class="fu"><a href="../reference/task_wait.html">task_wait</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="fu"><a href="../reference/task_result.html">task_result</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;packageNotFoundError in library(p, character.only = TRUE): there is no package called ‘cowsay’&gt;</span></span></code></pre></div>
<p>The same error as before, but the consequence is different - this is
because <strong>our</strong> code is not present. We update our
environment call to add <code>moo.R</code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/hipercow_environment.html">hipercow_environment_create</a></span><span class="op">(</span>packages <span class="op">=</span> <span class="st">"cowsay"</span>, sources <span class="op">=</span> <span class="st">"moo.R"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Updated environment 'default'</span></span></code></pre></div>
<p>(note that this replaces the previous definition of
<code>default</code>). Now, we can run our task:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/task_create_expr.html">task_create_expr</a></span><span class="op">(</span><span class="fu">say</span><span class="op">(</span><span class="fu">moo</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"cow"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Submitted task '65bffdad1d63b64caef0f1ab355b3078' using 'example'</span></span>
<span><span class="fu"><a href="../reference/task_wait.html">task_wait</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="fu"><a href="../reference/task_log.html">task_log_show</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">hipercow 1.1.5 running at '/home/runner/work/_temp/hv-20250513-2f9b482552ec'</span> </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> library paths:</span></span>
<span><span class="co">#&gt; • /home/runner/work/_temp/Library</span></span>
<span><span class="co">#&gt; • /opt/R/4.5.0/lib/R/site-library</span></span>
<span><span class="co">#&gt; • /opt/R/4.5.0/lib/R/library</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> id: 65bffdad1d63b64caef0f1ab355b3078</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> starting at: 2025-05-13 06:44:31.367247</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Task type: expression</span></span>
<span><span class="co">#&gt; • Expression: say(moo(5), by = "cow")</span></span>
<span><span class="co">#&gt; • Locals: (none)</span></span>
<span><span class="co">#&gt; • Environment: default</span></span>
<span><span class="co">#&gt;   R_GC_MEM_GROW: 3</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Loading environment 'default'...</span></span>
<span><span class="co">#&gt; • packages: <span style="font-weight: bold;">cowsay</span></span></span>
<span><span class="co">#&gt; • sources: <span style="font-weight: bold;">moo.R</span></span></span>
<span><span class="co">#&gt; • globals: <span style="font-style: italic;">(none)</span></span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> status: failure</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Error: there is no package called ‘cowsay’</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> finishing at: 2025-05-13 06:44:31.367247 (elapsed: 0.3051 secs)</span></span></code></pre></div>
<p>You can list as many source files as you want. If you are brave, you
could use <code><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir()</a></code> to do:</p>
<pre><code><span><span class="fu"><a href="../reference/hipercow_environment.html">hipercow_environment_create</a></span><span class="op">(</span></span>
<span>  sources <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/glob2rx.html" class="external-link">glob2rx</a></span><span class="op">(</span><span class="st">"R/"</span>, pattern <span class="op">=</span> <span class="st">"*.R"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre>
<p>which would load all <code>.R</code> files within the directory
<code>R/</code> of your <code>hipercow</code> root. Be careful not to
start recursively loading files though; this would happen if you
included <code><a href="https://rdrr.io/r/base/source.html" class="external-link">source()</a></code> commands within your R files which, when
followed, result in a cycle.</p>
</div>
</div>
<div class="section level2">
<h2 id="defining-globals">Defining globals<a class="anchor" aria-label="anchor" href="#defining-globals"></a>
</h2>
<p>A more advanced use of environments is to load large objects so that
they are ready when your task runs. Suppose we have a large object we
need to work with, for example a large loaded geojson file or a fit from
a model run, and we want to run a function on it.</p>
<p>The obvious thing to do is to write:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">myfn</span><span class="op">(</span><span class="va">my_big_data</span>, <span class="va">another_argument</span><span class="op">)</span></span></code></pre></div>
<p>where</p>
<ul>
<li>
<code>myfn</code> is our analysis function</li>
<li>
<code>my_big_data</code> is the large object</li>
<li>
<code>another_argument</code> is some other argument we’re passing
to the call</li>
</ul>
<p>When we do this, <code>hipercow</code> will save all the inputs to
disk, and this could be quite big. This could be even worse if this is
part of a bulk call, where multiple copies may be saved.</p>
<p>This problem can be so bad that we prevent it by default:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/task_create_expr.html">task_create_expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">my_big_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `task_create_expr()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Object too large to save with task: 'my_big_data'</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Objects saved with a hipercow task can only be 1 MB</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> You can increase the limit by increasing the value of the option</span></span>
<span><span class="co">#&gt;   'hipercow.max_size_local', even using 'Inf' to disable this check entirely</span></span>
<span><span class="co">#&gt;   (see the `vignette(hipercow::details)` vignette)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Better again, create large objects from your 'sources' argument to your</span></span>
<span><span class="co">#&gt;   environment, and then advertise this using the 'globals' argument (see the</span></span>
<span><span class="co">#&gt;   `vignette(hipercow::environments)` vignette)</span></span></code></pre></div>
<p>So, how do we get this object into our session? Suppose that
<code>read_big_data()</code> is the function that we used to read the
object in the first place. We might write a source file
<code>data.R</code> (the name is not important):</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_big_data</span> <span class="op">&lt;-</span> <span class="fu">read_big_data</span><span class="op">(</span><span class="st">"bigfile.shp"</span><span class="op">)</span></span></code></pre></div>
<p>and add this to our <code>sources</code>, but <strong>also</strong>
add <code>my_big_data</code> to <code>globals</code>. This tells
<code>hipercow</code> that the object <code>my_big_data</code> will be
globally available and that if it sees it in an expression that you
create it should not try and save it:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/hipercow_environment.html">hipercow_environment_create</a></span><span class="op">(</span>sources <span class="op">=</span> <span class="st">"data.R"</span>, globals <span class="op">=</span> <span class="st">"my_big_data"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Updated environment 'default'</span></span></code></pre></div>
<p>We can now create the task and run it:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/task_create_expr.html">task_create_expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">my_big_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Submitted task 'd436201fcba21c066854ea5a3ad6990c' using 'example'</span></span>
<span><span class="fu"><a href="../reference/task_wait.html">task_wait</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="../reference/task_result.html">task_result</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1000000</span></span></code></pre></div>
<p>If you use this approach, you should be aware of a few things:</p>
<ul>
<li>By default, there is no guarantee that the object you see when
creating the task is the same as the object loaded by
<code>sources</code>. You can enable this by setting the option
<code>hipercow.validate_globals</code> (see
<code><a href="../articles/details.html">vignette("details")</a></code>)</li>
<li>You should generally load (via <code><a href="https://rdrr.io/r/base/source.html" class="external-link">source()</a></code>) your data into
the local session too so you know what you are working with on the
cluster</li>
<li>Don’t update the definitions in the files you <code>source</code>
while some tasks are running or you will get confused about what was
loaded</li>
</ul>
</div>
<div class="section level2">
<h2 id="other-points">Other points<a class="anchor" aria-label="anchor" href="#other-points"></a>
</h2>
<p>Don’t rely on the environment being the same when you submitted your
tasks and when you load them, if you change the environment. That is,
don’t write:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/hipercow_environment.html">hipercow_environment_create</a></span><span class="op">(</span>packages <span class="op">=</span> <span class="st">"pkg.a"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/task_create_expr.html">task_create_expr</a></span><span class="op">(</span><span class="fu">use_pkg_a</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/hipercow_environment.html">hipercow_environment_create</a></span><span class="op">(</span>packages <span class="op">=</span> <span class="st">"pkg.b"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/task_create_expr.html">task_create_expr</a></span><span class="op">(</span><span class="fu">use_pkg_b</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>If you do this then the second call to
<code>hipercow_environment_create</code> <strong>overwrites</strong> the
<code>default</code> environment, and if the first task has not started
yet, it will load the second environment and not the first!</p>
<p>You can have as many named environments as you want, so we might
write that as:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/hipercow_environment.html">hipercow_environment_create</a></span><span class="op">(</span>packages <span class="op">=</span> <span class="st">"pkg.a"</span>, name <span class="op">=</span> <span class="st">"env_a"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/task_create_expr.html">task_create_expr</a></span><span class="op">(</span><span class="fu">use_pkg_a</span><span class="op">(</span><span class="op">)</span>, environment <span class="op">=</span> <span class="st">"env_a"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/hipercow_environment.html">hipercow_environment_create</a></span><span class="op">(</span>packages <span class="op">=</span> <span class="st">"pkg.b"</span>, name <span class="op">=</span> <span class="st">"env_a"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/task_create_expr.html">task_create_expr</a></span><span class="op">(</span><span class="fu">use_pkg_b</span><span class="op">(</span><span class="op">)</span>, environment <span class="op">=</span> <span class="st">"env_b"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="relationship-with-provisioning">Relationship with provisioning<a class="anchor" aria-label="anchor" href="#relationship-with-provisioning"></a>
</h2>
<p>When you <strong>provision</strong>, you install packages. This
defines the set of packages that are <strong>available</strong>, but
none will be loaded by default. You will be able to load any package
that you have installed via <code><a href="https://rdrr.io/r/base/library.html" class="external-link">library()</a></code>, or access the
functions by using the namespace operator <code>::</code>, but by
default only the normal minimal set of packages will be loaded.</p>
<p>If you specify packages within your provision script but do not load
them, that’s is fine - the packages exist in the library but may not be
used.</p>
<p>If you use packages in an environment that you do not provision, then
your task will fail to start once the package is not found.</p>
<p>When you provision a set of packages, it provisions all the
dependencies. Some people will add <code>tidyverse</code> to their
<code>pkgdepends.txt</code>, and then use (say) <code>ggplot2</code> in
their environment because that is a dependency of
<code>tidyverse</code>. This is fine.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn, Wes Hinsley, Paul Liétar.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
