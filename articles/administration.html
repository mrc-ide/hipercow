<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Administration • hipercow</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Administration">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hipercow</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/hipercow.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>General</h6></li>
    <li><a class="dropdown-item" href="../articles/packages.html">Packages and provisioning</a></li>
    <li><a class="dropdown-item" href="../articles/parallel.html">Parallel Tasks</a></li>
    <li><a class="dropdown-item" href="../articles/troubleshooting.html">Troubleshooting</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Details</h6></li>
    <li><a class="dropdown-item" href="../articles/details.html">Details</a></li>
    <li><a class="dropdown-item" href="../articles/environments.html">Environments</a></li>
    <li><a class="dropdown-item" href="../articles/stan.html">Using stan</a></li>
    <li><a class="dropdown-item" href="../articles/INLA.html">Using INLA on Windows</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Clusters</h6></li>
    <li><a class="dropdown-item" href="../articles/dide-cluster.html">The DIDE Cluster</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced topics</h6></li>
    <li><a class="dropdown-item" href="../articles/workers.html">Workers</a></li>
    <li><a class="dropdown-item" href="../articles/administration.html">Administration</a></li>
    <li><a class="dropdown-item" href="../articles/migration.html">Migration from didehpc</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/hipercow/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Administration</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/hipercow/blob/main/vignettes/administration.Rmd" class="external-link"><code>vignettes/administration.Rmd</code></a></small>
      <div class="d-none name"><code>administration.Rmd</code></div>
    </div>

    
    
<p>Are you reading the right manual? If you are not sure, you are
probably not!</p>
<div class="section level2">
<h2 id="rebuilding-the-bootstrap-library">Rebuilding the bootstrap library<a class="anchor" aria-label="anchor" href="#rebuilding-the-bootstrap-library"></a>
</h2>
<p>Ensure that the packages have built and are on the r-universe; this
might take a little while (it rebuilds once an hour). Check on the <a href="https://mrc-ide.r-universe.dev/builds" class="external-link">builds page</a> to see if
it has updated.</p>
<p>Install your own copy of <code>hipercow</code> as usual (you’ll need
<code>hipercow.dide</code> and <code>conan2</code> but these will be
installed on use if you don’t have them already).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hipercow"</span>, <span class="st">"hipercow.dide"</span><span class="op">)</span>,</span>
<span>  repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"https://mrc-ide.r-universe.dev"</span>, <span class="st">"https://cloud.r-project.org"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Set your working directory to anywhere on a network share (home
drives are fine for this).</p>
<p>Trigger building the bootstrap with:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">hipercow.dide</span><span class="fu">:::</span><span class="fu">bootstrap_update_all</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This will update all versions on the cluster that are at most one
minor version older than the most recent. It does have the side effect
of changing the Windows configuration for wherever you run the command
to the most recent supported R version.</p>
</div>
<div class="section level2">
<h2 id="testing-a-copy-of-hipercow-on-the-cluster">Testing a copy of hipercow on the cluster<a class="anchor" aria-label="anchor" href="#testing-a-copy-of-hipercow-on-the-cluster"></a>
</h2>
<p>If you want to test a copy of <code>hipercow</code> on the cluster,
you need to install a specific version of it somewhere it will be picked
up. The simplest way of doing this is to install everything into a new
bootstrap environment.</p>
<p>Create a new development bootstrap library by running (as above, from
a network location):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">hipercow</span><span class="fu">::</span><span class="fu"><a href="../reference/hipercow_init.html">hipercow_init</a></span><span class="op">(</span><span class="st">"."</span><span class="op">)</span></span>
<span><span class="fu">hipercow</span><span class="fu">::</span><span class="fu"><a href="../reference/hipercow_configure.html">hipercow_configure</a></span><span class="op">(</span><span class="st">"dide-windows"</span>, r_version <span class="op">=</span> <span class="st">"4.3.0"</span><span class="op">)</span></span>
<span><span class="fu">hipercow.dide</span><span class="fu">:::</span><span class="fu">bootstrap_update</span><span class="op">(</span>development <span class="op">=</span> <span class="st">"mrc-4827"</span><span class="op">)</span></span></code></pre></div>
<p>Now you can use your new version, after setting the option
<code>hipercow.development = TRUE</code>:</p>
<pre><code><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/hipercow" class="external-link">hipercow</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/hipercow_init.html">hipercow_init</a></span><span class="op">(</span><span class="st">"."</span>, <span class="st">"dide-windows"</span>, r_version <span class="op">=</span> <span class="st">"4.3.0"</span><span class="op">)</span> <span class="co"># needs to match above</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>hipercow.development <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/task_create_expr.html">task_create_expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/task_status.html">task_status</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/task_log.html">task_log_show</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/task_status.html">task_status</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/task_result.html">task_result</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span></code></pre>
<p>It is assumed that you have the development version installed locally
yourself, which is likely the case.</p>
</div>
<div class="section level2">
<h2 id="recreating-the-vignettes">Recreating the vignettes<a class="anchor" aria-label="anchor" href="#recreating-the-vignettes"></a>
</h2>
<p>These need to be run in a network share so set an environment
variable:-</p>
<pre><code>HIPERCOW_VIGNETTE_ROOT=/path/to/share</code></pre>
<p>or on Windows, a mapped drive, such as</p>
<pre><code>HIPERCOW_VIGNETTE_ROOT=Q:/hipercow_vignettes</code></pre>
<p>in your <code>.Renviron</code> indicating where we should work. We’ll
make lots of directories here.</p>
<p>Each vignette can be built by running (ideally in a fresh session
with the working directory as the package root)</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">hipercow.dide</span><span class="fu">:::</span><span class="fu">dide_check_credentials</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/knit.html" class="external-link">knit</a></span><span class="op">(</span><span class="st">"vignettes_src/dide-cluster.Rmd"</span>, <span class="st">"vignettes/dide-cluster.Rmd"</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/knit.html" class="external-link">knit</a></span><span class="op">(</span><span class="st">"vignettes_src/packages.Rmd"</span>, <span class="st">"vignettes/packages.Rmd"</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/knit.html" class="external-link">knit</a></span><span class="op">(</span><span class="st">"vignettes_src/workers.Rmd"</span>, <span class="st">"vignettes/workers.Rmd"</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/knit.html" class="external-link">knit</a></span><span class="op">(</span><span class="st">"vignettes_src/stan.Rmd"</span>, <span class="st">"vignettes/stan.Rmd"</span><span class="op">)</span></span></code></pre></div>
<p>which generates a new <code>dide-cluster.Rmd</code> file within
<code>vignettes/</code> that contains no runnable code and so can be
safely run on CI.</p>
<p>The <code>packages.Rmd</code> vignette requires that
<code>rfiglet</code> is installed via
<code>remotes::install_github()</code> to set up metadata so that
automatic installation will find the correct source. The vignette build
will fail early if that is not satisfied so that you can fix this.</p>
<p>You may want to run <code>options(hipercow.development = TRUE)</code>
to build using the development versions (see above).</p>
<p>The remaining vignettes use the example driver so they can be run
independent of any actual cluster.</p>
<p>On the command line, <code>make vignettes</code> will run through all
vignettes, but this seems to only work on some versions of make.</p>
</div>
<div class="section level2">
<h2 id="rtools-java-support-and-r-versions-windows">Rtools, Java support and R versions (Windows)<a class="anchor" aria-label="anchor" href="#rtools-java-support-and-r-versions-windows"></a>
</h2>
<p>We have batch files specific for each version of R that we support
which:-</p>
<ul>
<li>Set the path to <code>Rscript.exe</code> for that R version</li>
<li>Set the necessary environmental variables for a matching version of
RTools, such as <code>RTOOLS43_HOME</code> and
<code>BINPREF</code>.</li>
<li>Set the environment variable <code>JAVA_HOME</code> which the
<code>rJava</code> package looks up.</li>
</ul>
<p>These batch files live in
<code>\\projects.dide.ic.ac.uk\software\hpc\R</code>, and are called
things like <code>setr64_4_3_2.bat</code>, which looks like this.</p>
<pre><code>@echo off
IF EXIST I:\rtools (set RTOOLS_DRIVE=I) else (set RTOOLS_DRIVE=T)
FOR /f %%V in (%RTOOLS_DRIVE%:\Java\latest.txt) DO set JAVA_HOME=%RTOOLS_DRIVE%:\Java\%%V
set RTOOLS43_HOME=%RTOOLS_DRIVE%:\Rtools\Rtools43
set BINPREF=%RTOOLS_DRIVE%:/Rtools/Rtools43/x86_64-w64-mingw32.static.posix/bin/
set path=%RTOOLS_DRIVE%:\Rtools\Rtools43\usr\bin;%RTOOLS_DRIVE%:\Rtools\Rtools43\x86_64-w64-mingw32.static.posix\bin;C:\Program Files\R\R-4.3.2\bin\x64;%path%

echo Using RTOOLS43_HOME = %RTOOLS43_HOME%
echo Using JAVA_HOME = %JAVA_HOME%</code></pre>
<p>These get copied to <code>C:\Windows</code> on each cluster node,
using the HPC Cluster Manager. You simply select the nodes, right click,
“Run Command”, and look in the history for previous copy commands, to
copy the batch files in to %SystemRoot% - hence they are always in the
path on every node. You also need to edit the permissions to allow
everyone to read the file, by running this on each cluster node:-</p>
<pre><code>cacls %SYSTEMROOT%\setr64_*.bat /e /p everyone:r</code></pre>
<p>This also needs doing (manually) on the headnode, which runs the
BuildQueue.</p>
<div class="section level3">
<h3 id="adding-r-versions">Adding R Versions<a class="anchor" aria-label="anchor" href="#adding-r-versions"></a>
</h3>
<ul>
<li>Download the new R version into
<code>\\projects\software\hpc\R</code>.</li>
<li>Copy the most recent <code>install_r_....bat</code> file, to a name
matching the new R version. Edit it; usually just changing the R_VERSION
near the top is enough.</li>
<li>Copy the most recent <code>setr64_...bat</code> file, to a name
matching the new R version. Usually just the path is enough, but for
major versions, we’ll need to consult the documentation and see if we
need a new RTools version too.</li>
<li>Run the new <code>install</code> batch file on all cluster
nodes.</li>
<li>On <code>fi--didex1</code> edit
<code>C:\xampp\htdocs\mrcdata\hpc\api\v1\cluster_software\cluster_software.json</code>
to add the new version, and perhaps remove retired ones.</li>
</ul>
</div>
<div class="section level3">
<h3 id="updating-rtools">Updating RTools<a class="anchor" aria-label="anchor" href="#updating-rtools"></a>
</h3>
<p>This varies each time, and especially between different major R
versions. But essentially:-</p>
<ul>
<li>From any local computer, install the latest RTools into a sensible
folder in <code>I:\rtools</code>,</li>
<li>where I: is the bootstrap share, \wpia-hn</li>
<li>The rest is done with the separate <code>setr64_...bat</code> files;
review these for the versions that need the new RTools.</li>
</ul>
</div>
<div class="section level3">
<h3 id="updating-java-support">Updating Java support<a class="anchor" aria-label="anchor" href="#updating-java-support"></a>
</h3>
<ul>
<li>This is unlikely to be needed in any urgent sense, but should you
want a new or different version:</li>
<li>Download a JDK LTS zip file of your choice from <a href="www.azul.com">azul.com</a>, my favourite place for OpenJDK
builds.</li>
<li>Unzip into <code>I:\Java</code>, and then rename the folder it makes
it to a tidier version number, such as <code>21.0.2</code>
</li>
<li>Update <code>I:\Java\latest.txt</code> to contain that new version
string.</li>
<li>JAVA_HOME will then point to the root of the Java JDK, and
<code>rJava</code> and <code>xlsx</code> will work happily.</li>
</ul>
</div>
<div class="section level3">
<h3 id="stan">stan<a class="anchor" aria-label="anchor" href="#stan"></a>
</h3>
<p>See <code><a href="../articles/stan.html">vignette("stan")</a></code> for general comments about
stan.</p>
<p>To update the installation of <code>CmdStan</code> on the
<code>I:/</code> (and generally available), run:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">hipercow</span><span class="fu">::</span><span class="fu"><a href="../reference/hipercow_init.html">hipercow_init</a></span><span class="op">(</span>driver <span class="op">=</span> <span class="st">"dide-windows"</span><span class="op">)</span></span>
<span><span class="fu">hipercow.dide</span><span class="fu">:::</span><span class="fu">cmdstan_install</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Users should not run this themselves into their home directories as
the installation is about 1GB</p>
<p>There are influential environment variables set at the driver level
which prevent stan from breaking our Rtools installation
(<code>CMDSTAN</code> and <code>CMDSTANR_USE_RTOOLS</code>).</p>
<p>For details see:</p>
<ul>
<li><a href="https://github.com/stan-dev/cmdstanr/issues/979" class="external-link uri">https://github.com/stan-dev/cmdstanr/issues/979</a></li>
<li><a href="https://github.com/stan-dev/cmdstanr/pull/978" class="external-link uri">https://github.com/stan-dev/cmdstanr/pull/978</a></li>
<li><a href="https://github.com/stan-dev/cmdstanr/pull/980" class="external-link uri">https://github.com/stan-dev/cmdstanr/pull/980</a></li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn, Wes Hinsley, Paul Liétar.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
