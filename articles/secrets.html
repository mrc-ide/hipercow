<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using secrets on the cluster • hipercow</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Using secrets on the cluster">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hipercow</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.8</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/hipercow.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>General</h6></li>
    <li><a class="dropdown-item" href="../articles/packages.html">Packages and provisioning</a></li>
    <li><a class="dropdown-item" href="../articles/parallel.html">Parallel Tasks</a></li>
    <li><a class="dropdown-item" href="../articles/troubleshooting.html">Troubleshooting</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Details</h6></li>
    <li><a class="dropdown-item" href="../articles/details.html">Details</a></li>
    <li><a class="dropdown-item" href="../articles/environments.html">Environments</a></li>
    <li><a class="dropdown-item" href="../articles/secrets.html">Using secrets on the cluster</a></li>
    <li><a class="dropdown-item" href="../articles/stan.html">Using stan</a></li>
    <li><a class="dropdown-item" href="../articles/INLA.html">Using INLA on Windows</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Clusters</h6></li>
    <li><a class="dropdown-item" href="../articles/dide-cluster.html">The DIDE Cluster</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced topics</h6></li>
    <li><a class="dropdown-item" href="../articles/workers.html">Workers</a></li>
    <li><a class="dropdown-item" href="../articles/administration.html">Administration</a></li>
    <li><a class="dropdown-item" href="../articles/migration.html">Migration from didehpc</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/hipercow/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Using secrets on the cluster</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/hipercow/blob/main/vignettes/secrets.Rmd" class="external-link"><code>vignettes/secrets.Rmd</code></a></small>
      <div class="d-none name"><code>secrets.Rmd</code></div>
    </div>

    
    
<!-- WARNING - if you run this vignette it will delete and recreate
     your keys -->
<!-- Please edit the file in vignettes_src/ -->
<div class="section level2">
<h2 id="using-cyphr">Using <code>cyphr</code><a class="anchor" aria-label="anchor" href="#using-cyphr"></a>
</h2>
<p>We assume that you have followed the <a href="https://docs.ropensci.org/cyphr/articles/data.html" class="external-link">“data
encryption” vignette</a> in <code>cyphr</code> and that you are running
from the same directory that it is set up for. (You may or may not be
using orderly with this, the procedure is the same either way).</p>
<p>We’ll quickly set up the same basic structure in this vignette.</p>
<p>First, we configure hipercow at this directory:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/hipercow" class="external-link">hipercow</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/hipercow_init.html">hipercow_init</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ Initialised hipercow at '.' (/home/rfitzjoh/net/home/cluster/hipercow-vignette/hv-20250912-187f90285932a2)</span></span>
<span><span class="co">#&gt; ℹ Next, call 'hipercow_configure()'</span></span>
<span><span class="fu"><a href="../reference/hipercow_configure.html">hipercow_configure</a></span><span class="op">(</span>driver <span class="op">=</span> <span class="st">"dide-windows"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ Configured hipercow to use 'dide-windows'</span></span></code></pre></div>
<p>We assume that you have ssh keys that work for <strong>your
machine</strong> from your previous use of <code>cyphr</code> and the
vignette already has these working. These will have a password, but for
the purposes of this vignette you will not see the password prompt
here.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/cyphr/reference/data_admin.html" class="external-link">data_admin_init</a></span><span class="op">(</span><span class="st">"."</span><span class="op">)</span></span>
<span><span class="co">#&gt; Generating data key</span></span>
<span><span class="co">#&gt; Authorising ourselves</span></span>
<span><span class="co">#&gt; Adding key 78:59:4c:6c:61:a1:9e:d8:c8:02:22:49:33:c9:8e:db:b3:d1:c3:65:9b:1d:76:5b:50:e5:36:2c:da:52:1e:f8</span></span>
<span><span class="co">#&gt;   user: rfitzjoh</span></span>
<span><span class="co">#&gt;   host: wpia-dide300</span></span>
<span><span class="co">#&gt;   date: 2025-09-12 13:41:53.50033</span></span>
<span><span class="co">#&gt; Verifying</span></span></code></pre></div>
<p>We can locally work with this key just fine to encrypt some small
secret data set, <code>x</code></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">key</span> <span class="op">&lt;-</span> <span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/cyphr/reference/data_user.html" class="external-link">data_key</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/cyphr/reference/encrypt.html" class="external-link">encrypt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"data.rds"</span><span class="op">)</span>, <span class="va">key</span><span class="op">)</span></span></code></pre></div>
<p>What we want to do is to write a cluster job that can use this secret
data.</p>
<p>Firstly, we need to install <code>cyphr</code> into the library that
will run on the cluster. You could also do this by adding
<code>cyphr</code> to your <code>pkgdepends.txt</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/hipercow_provision.html">hipercow_provision</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"pkgdepends"</span>, refs <span class="op">=</span> <span class="st">"cyphr"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ℹ Looking for active tasks before installation</span></span>
<span><span class="co">#&gt; ✔ No tasks running</span></span>
<span><span class="co">#&gt; /`-'\  _______  ___  ___ ____</span></span>
<span><span class="co">#&gt; \,T./ / __/ _ \/ _ \/ _ `/ _ \</span></span>
<span><span class="co">#&gt;   |   \__/\___/_//_/\_,_/_//_/</span></span>
<span><span class="co">#&gt;   |   ---- THE  LIBRARIAN ----</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Bootstrapping from: I:/bootstrap-windows/4.4.2</span></span>
<span><span class="co">#&gt; Installing into library: hipercow/lib/windows/4.4.2</span></span>
<span><span class="co">#&gt; Using method pkgdepends</span></span>
<span><span class="co">#&gt; Running in path: V:/cluster/hipercow-vignette/hv-20250912-187f90285932a2</span></span>
<span><span class="co">#&gt; Library paths:</span></span>
<span><span class="co">#&gt;   - V:/cluster/hipercow-vignette/hv-20250912-187f90285932a2/hipercow/lib/windows/4.4.2</span></span>
<span><span class="co">#&gt;   - C:/Program Files/R/R-4.4.2/library</span></span>
<span><span class="co">#&gt; id: 20250912124156</span></span>
<span><span class="co">#&gt; Logs from pkgdepends follow:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── repos </span></span>
<span><span class="co">#&gt; • https://cloud.r-project.org</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── refs </span></span>
<span><span class="co">#&gt; • cyphr</span></span>
<span><span class="co">#&gt; ✔ Updated metadata database: 7.83 MB in 6 files.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Updating metadata database</span></span>
<span><span class="co">#&gt; ✔ Updating metadata database ... done</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; + askpass      1.2.1  [dl]</span></span>
<span><span class="co">#&gt; + cyphr        1.1.7  [dl]</span></span>
<span><span class="co">#&gt; + getPass      0.2-4  [dl]</span></span>
<span><span class="co">#&gt; + openssl      2.3.3  [dl]</span></span>
<span><span class="co">#&gt; + rstudioapi   0.17.1 [dl]</span></span>
<span><span class="co">#&gt; + sodium       1.4.0  [dl]</span></span>
<span><span class="co">#&gt; + sys          3.4.3  [dl]</span></span>
<span><span class="co">#&gt; ℹ Getting 7 pkgs with unknown sizes</span></span>
<span><span class="co">#&gt; ✔ Got askpass 1.2.1 (x86_64-w64-mingw32) (74.80 kB)</span></span>
<span><span class="co">#&gt; ✔ Got rstudioapi 0.17.1 (i386+x86_64-w64-mingw32) (346.85 kB)</span></span>
<span><span class="co">#&gt; ✔ Got sys 3.4.3 (x86_64-w64-mingw32) (47.98 kB)</span></span>
<span><span class="co">#&gt; ✔ Got openssl 2.3.3 (x86_64-w64-mingw32) (3.47 MB)</span></span>
<span><span class="co">#&gt; ✔ Got sodium 1.4.0 (x86_64-w64-mingw32) (660.91 kB)</span></span>
<span><span class="co">#&gt; ✔ Got cyphr 1.1.7 (i386+x86_64-w64-mingw32) (400.78 kB)</span></span>
<span><span class="co">#&gt; ✔ Got getPass 0.2-4 (x86_64-w64-mingw32) (493.58 kB)</span></span>
<span><span class="co">#&gt; ✔ Installed askpass 1.2.1  (582ms)</span></span>
<span><span class="co">#&gt; ✔ Installed cyphr 1.1.7  (647ms)</span></span>
<span><span class="co">#&gt; ✔ Installed getPass 0.2-4  (755ms)</span></span>
<span><span class="co">#&gt; ✔ Installed sys 3.4.3  (707ms)</span></span>
<span><span class="co">#&gt; ✔ Installed sodium 1.4.0  (894ms)</span></span>
<span><span class="co">#&gt; ✔ Installed rstudioapi 0.17.1  (1.1s)</span></span>
<span><span class="co">#&gt; ✔ Installed openssl 2.3.3  (1.3s)</span></span>
<span><span class="co">#&gt; ✔ Summary:   7 new  in 5.9s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -------------------------------------------------------------------------------</span></span>
<span><span class="co">#&gt; Writing library description to 'hipercow/lib/windows/4.4.2/.conan/20250912124156'</span></span>
<span><span class="co">#&gt; Done!</span></span>
<span><span class="co">#&gt; ✔ Installation script finished successfully in 20.39 secs</span></span></code></pre></div>
<p>We might then naively try and run a task that reads the encrypted
data:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/task_create_expr.html">task_create_expr</a></span><span class="op">(</span></span>
<span>  <span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/cyphr/reference/encrypt.html" class="external-link">decrypt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data.rds"</span><span class="op">)</span>, <span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/cyphr/reference/data_user.html" class="external-link">data_key</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ Submitted task '20bee48990a9104d3cd497a02b80cdf2' using 'dide-windows'</span></span></code></pre></div>
<p>This will fail:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/task_result.html">task_result</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;simpleError: Did not find default ssh public key at '~/.ssh/id_rsa.pub'</span></span>
<span><span class="co">#&gt; You can create a key here by running</span></span>
<span><span class="co">#&gt;   cyphr::ssh_keygen("~/.ssh/id_rsa.pub")&gt;</span></span></code></pre></div>
<p>The reason why it fails is because the cluster cannot see the key
that we are using to work with cyphr; the <code>~/.ssh/id_rsa.pub</code>
referred to here would be on the cluster node that ran the job and not
the key that exists on your machine.</p>
<p>What we can do is to create another key that will be found in your
network home directory:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dide_generate_keypair.html">dide_generate_keypair</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ Created new private key at '/home/rfitzjoh/net/home/.hipercow/key'</span></span>
<span><span class="co">#&gt; ✔ Created new public key at '/home/rfitzjoh/net/home/.hipercow/key.pub'</span></span>
<span><span class="co">#&gt; ✔ Saved public key into your keychain</span></span></code></pre></div>
<p>We need to authorise this key with cyphr, which we can do by running
a short cluster job:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/task_create_expr.html">task_create_expr</a></span><span class="op">(</span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/cyphr/reference/data_user.html" class="external-link">data_request_access</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ Submitted task 'd4163d6ff3e2dafafd98a26116bd8352' using 'dide-windows'</span></span></code></pre></div>
<p>Once that has run, we will see the request for access, which is
actually us but from the cluster:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/cyphr/reference/data_admin.html" class="external-link">data_admin_list_requests</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 1 key:</span></span>
<span><span class="co">#&gt;   51:40:32:58:11:4a:05:df:c3:7a:27:2b:25:17:6d:53:66:41:f0:f0:48:d6:2b:d6:23:b1:39:7a:f9:5f:58:66</span></span>
<span><span class="co">#&gt;     user: rfitzjoh</span></span>
<span><span class="co">#&gt;     host: WPIA-054</span></span>
<span><span class="co">#&gt;     date: 2025-09-12 13:42:21.019979</span></span></code></pre></div>
<p>We can authorise ourselves:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/cyphr/reference/data_admin.html" class="external-link">data_admin_authorise</a></span><span class="op">(</span>yes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; There is 1 request for access</span></span>
<span><span class="co">#&gt; Adding key 51:40:32:58:11:4a:05:df:c3:7a:27:2b:25:17:6d:53:66:41:f0:f0:48:d6:2b:d6:23:b1:39:7a:f9:5f:58:66</span></span>
<span><span class="co">#&gt;   user: rfitzjoh</span></span>
<span><span class="co">#&gt;   host: WPIA-054</span></span>
<span><span class="co">#&gt;   date: 2025-09-12 13:42:21.019979</span></span>
<span><span class="co">#&gt; Added 1 key</span></span>
<span><span class="co">#&gt; If you are using git, you will need to commit and push:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     git add .cyphr</span></span>
<span><span class="co">#&gt;     git commit -m "Authorised rfitzjoh"</span></span>
<span><span class="co">#&gt;     git push</span></span></code></pre></div>
<p>And now we can run our jobs that require encrypted data</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/task_create_expr.html">task_create_expr</a></span><span class="op">(</span></span>
<span>  <span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/cyphr/reference/encrypt.html" class="external-link">decrypt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data.rds"</span><span class="op">)</span>, <span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/cyphr/reference/data_user.html" class="external-link">data_key</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ Submitted task 'da8170adcb81ff1b69af55ecc146b74e' using 'dide-windows'</span></span></code></pre></div>
<p>This time we can read the data!</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/task_result.html">task_result</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 0.05838293 0.41034069 0.22518724 0.11884682 0.28322052 0.82149523</span></span>
<span><span class="co">#&gt;  [7] 0.41899393 0.16678808 0.79077363 0.81735793</span></span></code></pre></div>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn, Wes Hinsley, Paul Liétar.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
